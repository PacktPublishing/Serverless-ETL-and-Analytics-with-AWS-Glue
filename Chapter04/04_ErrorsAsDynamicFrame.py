# Chapter 04
# Code Snippet 04 - AWS Glue Transformations - ErrorsAsDynamicFrame

import sys
import sys
from awsglue.transforms import *
from awsglue.utils import getResolvedOptions
from awsglue.context import GlueContext
from pyspark.context import SparkContext
from awsglue.job import Job
from awsglue.dynamicframe import DynamicFrame
from pyspark.sql import SparkSession
from pyspark.sql.types import StructField, StructType, IntegerType, StringType

# Initialize SparkContext, GlueContext and SparkSession.
params = []
if '--JOB_NAME' in sys.argv:
    params.append('JOB_NAME')
args = getResolvedOptions(sys.argv, params)
if 'JOB_NAME' in args:
    jobname = args['JOB_NAME']
else:
    jobname = "test"

sc = SparkContext.getOrCreate()
glueContext = GlueContext(sc)
spark = glueContext.spark_session
logger = glueContext.get_logger()

job = Job(glueContext)
job.init(jobname, args)

def createSampleDynamicFrameForErrorsAsDynamicFrame():
    jsonString = """{
        "jsonrecords": [
            {
            "company": "DummyCorp1",
            "employees": [
                {
                "email": "foo@company1.com",
                "name": "foo1"
                },
                {
                "email": "bar@company1.com",
                "name": "bar1"
                }
            ]
            },
            {
            "company": "DummyCorp2",
            "employees": [
                {
                "email": "foo@company2.com",
                "name": "foo2"
                },
                {
                "email": "bar@company2.com",
                "name": "bar2"
                }
            ]
            },
            {
            "company": "DummyCorp3",
            "employees": [
                {
                "email": "foo@company3.com",
                "name": "foo3"
                },
                {
                "email": "bar@company3.com",
                "name": "bar3"
                }
            ]
            }
        ]
        }"""
    # There is a syntax error in the next JSON string which will throw errors while pars
    jsonString2 = """{"jsonrecords":[{"company":"DummyCorp1","employees":[{"email":"foo@company1.com","name":"foo1"},{"email":"bar@company1.com","name":"bar1"}]},{"company":"DummyCorp2","employees":[{"email":"foo@company2.com","name":"foo2"},{"email":"bar@company2.com","name":"bar2"}]},{"company":"DummyCorp3","employees":[{"email":"foo@company3.com","name":"foo3"},{"email":"bar@company3.com","name":"bar3}]}]}"""
    company_directory = [['Seattle, WA',jsonString]]
    company_directory_2 = [['Sydney, NSW',jsonString2]]
    company_directory_schema = StructType([StructField("location", StringType()) ,StructField("companies_json", StringType())]) 
    data = spark.createDataFrame(company_directory, schema = company_directory_schema)
    data2 = spark.createDataFrame(company_directory_2, schema = company_directory_schema)
    return DynamicFrame.fromDF(data.union(data2), glueContext, "sample_nested_data")

datasource2 = createSampleDynamicFrameForErrorsAsDynamicFrame()

# Output: 
# +-----------+--------------------+
# |   location|      companies_json|
# +-----------+--------------------+
# |Seattle, WA|{
#         "jsonre...|
# |Sydney, NSW|{"jsonrecords":[{...|
# +-----------+--------------------+
datasource2.toDF().show()

# Applying a random transformation to trigger errors with totalThreshold set to 1
unbox0 = Unbox.apply(
    frame = datasource2, 
    path = "companies_json", 
    format = "json",
    totalThreshold=1
)

# Output: 
# +-----------+--------------------+
# |   location|      companies_json|
# +-----------+--------------------+
# |Seattle, WA|{[{DummyCorp1, [{...|
# +-----------+--------------------+
# 
# We can only see one record. Instead of 2.
unbox0.toDF().show()

# Output: 
# root
# |-- location: string
# |-- companies_json: struct
# |    |-- jsonrecords: array
# |    |    |-- element: struct
# |    |    |    |-- company: string
# |    |    |    |-- employees: array
# |    |    |    |    |-- element: struct
# |    |    |    |    |    |-- email: string
# |    |    |    |    |    |-- name: string
unbox0.printSchema()

# Output:
# +---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
# |error                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
# +---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
# |{{  File "/tmp/7748783534053094680", line 714, in <module>
#     sys.exit(main())
#   File "/tmp/7748783534053094680", line 686, in main
#     response = handler(content)
#   File "/tmp/7748783534053094680", line 318, in execute_request
#     result = node.execute()
#   File "/tmp/7748783534053094680", line 229, in execute
#     exec(code, global_dict)
#   File "<stdin>", line 5, in <module>
#   File "/home/glue_user/aws-glue-libs/PyGlue.zip/awsglue/transforms/transform.py", line 24, in apply
#     return transform(*args, **kwargs)
#   File "/home/glue_user/aws-glue-libs/PyGlue.zip/awsglue/transforms/unbox.py", line 35, in __call__
#     return frame.unbox(path, format, transformation_ctx, info, stageThreshold, totalThreshold, **options)
# , }, unbox failed Unexpected end-of-input in VALUE_STRING
#  at [Source: (com.amazonaws.services.glue.readers.BufferedStream); line: 1, column: 392], com.fasterxml.jackson.core.io.JsonEOFException: Unexpected end-of-input in VALUE_STRING
#  at [Source: (com.amazonaws.services.glue.readers.BufferedStream); line: 1, column: 392]
# 	at com.fasterxml.jackson.core.base.ParserMinimalBase._reportInvalidEOF(ParserMinimalBase.java:664)
# 	at com.fasterxml.jackson.core.base.ParserMinimalBase._reportInvalidEOF(ParserMinimalBase.java:641)
# 	at com.fasterxml.jackson.core.json.UTF8StreamJsonParser._loadMoreGuaranteed(UTF8StreamJsonParser.java:2373)
# 	at com.fasterxml.jackson.core.json.UTF8StreamJsonParser._finishString2(UTF8StreamJsonParser.java:2458)
# 	at com.fasterxml.jackson.core.json.UTF8StreamJsonParser._finishAndReturnString(UTF8StreamJsonParser.java:2438)
# 	at com.fasterxml.jackson.core.json.UTF8StreamJsonParser.getText(UTF8StreamJsonParser.java:294)
# 	at com.amazonaws.services.glue.readers.JSONReader.processToken(JSONReader.scala:304)
# 	at com.amazonaws.services.glue.readers.JacksonReader.$anonfun$nextFailFast$5(JacksonReader.scala:143)
# 	at com.amazonaws.services.glue.readers.JacksonReader.$anonfun$nextFailFast$5$adapted(JacksonReader.scala:142)
# 	at scala.collection.Iterator.foreach(Iterator.scala:941)
# 	at scala.collection.Iterator.foreach$(Iterator.scala:941)
# 	at scala.collection.AbstractIterator.foreach(Iterator.scala:1429)
# 	at com.amazonaws.services.glue.readers.JacksonReader.$anonfun$nextFailFast$1(JacksonReader.scala:142)
# 	at com.amazonaws.services.glue.DynamicRecordBuilder.handleErr(DynamicRecordBuilder.scala:209)
# 	at com.amazonaws.services.glue.DynamicRecordBuilder.handleErrorWithException(DynamicRecordBuilder.scala:202)
# 	at com.amazonaws.services.glue.readers.JacksonReader.nextFailFast(JacksonReader.scala:138)
# 	at com.amazonaws.services.glue.readers.JacksonReader.next(JacksonReader.scala:111)
# 	at com.amazonaws.services.glue.readers.JSONReader.next(JSONReader.scala:207)
# 	at com.amazonaws.services.glue.DynamicFrame.$anonfun$unbox$2(DynamicFrame.scala:590)
# 	at com.amazonaws.services.glue.DynamicFrame$.$anonfun$inlineErrors$1(DynamicFrame.scala:2074)
# 	at scala.collection.Iterator$$anon$10.next(Iterator.scala:459)
# 	at scala.collection.Iterator$$anon$10.next(Iterator.scala:459)
# 	at scala.collection.Iterator$$anon$12.hasNext(Iterator.scala:512)
# 	at scala.collection.Iterator$$anon$10.hasNext(Iterator.scala:458)
# 	at scala.collection.Iterator$$anon$10.hasNext(Iterator.scala:458)
# 	at scala.collection.Iterator$$anon$12.hasNext(Iterator.scala:511)
# 	at scala.collection.Iterator$$anon$10.hasNext(Iterator.scala:458)
# 	at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1.processNext(Unknown Source)
# 	at org.apache.spark.sql.execution.BufferedRowIterator.hasNext(BufferedRowIterator.java:43)
# 	at org.apache.spark.sql.execution.WholeStageCodegenExec$$anon$1.hasNext(WholeStageCodegenExec.scala:755)
# 	at org.apache.spark.sql.execution.SparkPlan.$anonfun$getByteArrayRdd$1(SparkPlan.scala:350)
# 	at org.apache.spark.rdd.RDD.$anonfun$mapPartitionsInternal$2(RDD.scala:898)
# 	at org.apache.spark.rdd.RDD.$anonfun$mapPartitionsInternal$2$adapted(RDD.scala:898)
# 	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:52)
# 	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:373)
# 	at org.apache.spark.rdd.RDD.iterator(RDD.scala:337)
# 	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:90)
# 	at org.apache.spark.scheduler.Task.run(Task.scala:131)
# 	at org.apache.spark.executor.Executor$TaskRunner.$anonfun$run$3(Executor.scala:497)
# 	at org.apache.spark.util.Utils$.tryWithSafeFinally(Utils.scala:1439)
# 	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:500)
# 	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
# 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
# 	at java.lang.Thread.run(Thread.java:750)
# , {Sydney, NSW, {"jsonrecords":[{"company":"DummyCorp1","employees":[{"email":"foo@company1.com","name":"foo1"},{"email":"bar@company1.com","name":"bar1"}]},{"company":"DummyCorp2","employees":[{"email":"foo@company2.com","name":"foo2"},{"email":"bar@company2.com","name":"bar2"}]},{"company":"DummyCorp3","employees":[{"email":"foo@company3.com","name":"foo3"},{"email":"bar@company3.com","name":"bar3}]}]}}}|
# +---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
ErrorsAsDynamicFrame.apply(unbox0).toDF().show(truncate=False)

job.commit()